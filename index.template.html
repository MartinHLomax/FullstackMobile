<!doctype html>
<html lang="da">
  <head>
    <meta charset="utf-8" />
    <!-- Content Security Policy for enhanced security -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' 'unsafe-inline' https://esm.sh https://cdn.jsdelivr.net;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: https:;
      connect-src 'self' https://*.supabase.co wss://*.supabase.co;
      font-src 'self' data:;
      object-src 'none';
      base-uri 'self';
      form-action 'self';
      frame-ancestors 'none';
      upgrade-insecure-requests;
    ">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0b1020" />
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <title>Shopping List Â· Supabase + GitHub Pages</title>
    <style>
      :root { --gap: 12px; --radius: 14px; --bg: #0b1020; --card: #121935; --surface: #0f1633; --border: #273057; --border-btn: #3d4b86; --text: #f2f4f8; --muted: #a6b0d6; --accent: #3ecf8e; --danger: #5c1a2a; --danger-border: #a43d5b; }
      html, body { margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; background:var(--bg); color:var(--text); }
      a { color: inherit; }
      .wrap { max-width: 520px; margin: 0 auto; padding: 20px 16px 40px; }
      header { display:flex; align-items:center; justify-content:space-between; gap:var(--gap); margin-bottom: 16px; }
      .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
      .row { display:flex; gap: var(--gap); align-items:center; }
      .muted { color:var(--muted); font-size: 14px; }
      button, input { font: inherit; }
      button { padding: 10px 14px; border-radius: 12px; border:1px solid var(--border-btn); background:#1a244d; color:#fff; cursor:pointer; transition: filter 0.1s; }
      button:hover { filter: brightness(1.15); }
      button:active { filter: brightness(0.95); }
      input[type="text"], input[type="email"] { padding: 10px 12px; border-radius: 12px; border:1px solid var(--border-btn); background:var(--surface); color:#fff; width:100%; }
      .pill { padding: 4px 10px; border:1px solid var(--border-btn); background:var(--surface); border-radius: 999px; font-size:12px; }
      ul { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px; }
      li.item { display:flex; align-items:center; justify-content:space-between; gap:var(--gap); background:var(--surface); border:1px solid var(--border); border-radius: 12px; padding: 10px 12px; transition: background 0.15s; }
      li.item:active { background: #1a244d; }
      .item-name { font-weight:600; font-size:15px; }
      .qty-controls { display:flex; align-items:center; gap:6px; }
      .qty-btn { width:34px; height:34px; border-radius:10px; font-size:16px; }
      .remove-btn { background:var(--danger); border-color:var(--danger-border); width:34px; height:34px; border-radius:10px; padding:0; }

      /* Tabs */
      .tab-bar { display:flex; gap:0; }
      .tab-btn { flex:1; padding:12px 0; border:1px solid var(--border); background:var(--surface); color:var(--muted); font-weight:600; font-size:14px; cursor:pointer; transition:background 0.15s, color 0.15s; border-bottom:2px solid transparent; }
      .tab-btn:first-child { border-radius:var(--radius) 0 0 0; }
      .tab-btn:last-child { border-radius:0 var(--radius) 0 0; }
      .tab-btn:hover { background:#1a244d; }
      .tab-btn.active { background:var(--card); color:var(--text); border-bottom-color:var(--accent); }
      .tab-count { font-weight:400; color:var(--muted); font-size:12px; margin-left:4px; }
      .tab-btn.active .tab-count { color:var(--accent); }
      .list-card-tabs { border-top-left-radius:0; border-top-right-radius:0; border-top:none; margin-top:0; }

      /* Add row integrated in list card */
      .add-row { display:flex; gap:8px; margin-bottom:12px; }
      .add-row input[type="text"] { padding:8px 12px; height:40px; box-sizing:border-box; }
      .add-row button { height:40px; width:40px; padding:0; font-size:20px; flex-shrink:0; border-radius:10px; }

      /* Mobile */
      @media (max-width: 520px) {
        .wrap { padding: 16px 12px 32px; }
        header { gap: 8px; }
        h1 { font-size: 20px !important; }
        .card { padding: 12px; }
        .pill { font-size: 11px; }
        li.item { display: grid; grid-template-columns: 1fr; row-gap: 8px; align-items: start; }
        li.item .row { justify-content: space-between; width: 100%; }
        .item-name { word-break: break-word; }
        .qty-controls { justify-content: space-between; width: 100%; }
        .qty-btn, .remove-btn { width: 40px; height: 40px; }
        .add-row input[type="text"] { height:44px; }
        .add-row button { height:44px; width:44px; }
        .tab-btn { font-size:13px; padding:10px 0; }
      }
</style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1 style="margin:0;font-size:22px;font-weight:700;">Shopping List</h1>
        <div class="row" id="userBadge" hidden>
          <span class="pill" id="userEmail"></span>
          <button id="logoutBtn" title="Log ud" style="padding:6px 12px;font-size:13px;">Log ud</button>
        </div>
      </header>

      <!-- Auth -->
      <section class="card" id="authSection" style="margin-bottom:16px;">
        <h2 style="margin-top:0;font-size:16px;">Login</h2>
        <p class="muted" style="margin:0 0 10px;">Kun inviterede brugere kan logge ind.</p>
        <div class="row">
          <input id="emailInput" type="email" placeholder="din@email.dk" />
          <button id="magicBtn">Send link</button>
        </div>
      </section>

      <!-- Tabs -->
      <div class="tab-bar">
        <button class="tab-btn active" data-list="shopping" id="tabShopping">IndkÃ¸b <span class="tab-count" id="countShopping"></span></button>
        <button class="tab-btn" data-list="memo" id="tabMemo">Huskeliste <span class="tab-count" id="countMemo"></span></button>
      </div>

      <!-- List card -->
      <section class="card list-card-tabs">
        <div class="add-row">
          <input id="itemInput" type="text" placeholder="TilfÃ¸j vare..." />
          <button id="addBtn" title="TilfÃ¸j">+</button>
        </div>
        <ul id="list"></ul>
        <div id="clearAllContainer" style="margin-top:14px; text-align:center;" hidden>
          <button id="clearAllBtn" style="background:var(--danger); border-color:var(--danger-border); font-size:13px; padding:8px 16px;">Slet alle</button>
        </div>
      </section>
    </div>

    <script type="module">
      const SUPABASE_URL = "{{SUPABASE_URL}}"; // Will be replaced by build script
      const SUPABASE_ANON_KEY = "{{SUPABASE_ANON_KEY}}"; // Will be replaced by build script

      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true,
          storage: window.localStorage
        }
      });

      // --- Connection Logging ---
      let _lastLogTime = 0;
      const LOG_THROTTLE_MS = 5000;

      async function logConnection(eventType, user) {
        const now = Date.now();
        if (now - _lastLogTime < LOG_THROTTLE_MS) return;
        _lastLogTime = now;

        if (eventType === 'TOKEN_REFRESHED' || eventType === 'INITIAL_SESSION') return;

        if (!user) {
          const { data: { user: currentUser } } = await supabase.auth.getUser();
          user = currentUser;
        }
        if (!user) return;

        const isPwa = window.matchMedia('(display-mode: standalone)').matches
          || window.navigator.standalone === true
          || window.location.search.includes('source=pwa');

        const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;

        const entry = {
          user_id:         user.id,
          email:           user.email || null,
          event_type:      eventType,
          user_agent:      navigator.userAgent || null,
          language:        navigator.language || null,
          platform:        navigator.platform || null,
          screen_w:        screen.width || null,
          screen_h:        screen.height || null,
          viewport_w:      window.innerWidth || null,
          viewport_h:      window.innerHeight || null,
          referrer:        document.referrer || null,
          page_url:        window.location.href || null,
          is_pwa:          isPwa,
          connection_type: conn?.effectiveType || null,
          is_online:       navigator.onLine
        };

        supabase.from('connection_log').insert(entry).then(({ error }) => {
          if (error) console.warn('Connection log error:', error.message);
        });
      }

      // UI refs
      const userBadge = document.getElementById('userBadge');
      const userEmail = document.getElementById('userEmail');
      const logoutBtn = document.getElementById('logoutBtn');
      const magicBtn = document.getElementById('magicBtn');
      const emailInput = document.getElementById('emailInput');
      const githubBtn = document.getElementById('githubBtn');
      const authSection = document.getElementById('authSection');
      const itemInput = document.getElementById('itemInput');
      const addBtn = document.getElementById('addBtn');
      const list = document.getElementById('list');
      const clearAllContainer = document.getElementById('clearAllContainer');
      const clearAllBtn = document.getElementById('clearAllBtn');

      // --- Tab state ---
      let activeList = 'shopping';
      const tabShopping = document.getElementById('tabShopping');
      const tabMemo = document.getElementById('tabMemo');
      const countShopping = document.getElementById('countShopping');
      const countMemo = document.getElementById('countMemo');

      function switchTab(listId) {
        activeList = listId;
        tabShopping.classList.toggle('active', listId === 'shopping');
        tabMemo.classList.toggle('active', listId === 'memo');
        loadItems();
      }
      tabShopping?.addEventListener('click', () => switchTab('shopping'));
      tabMemo?.addEventListener('click', () => switchTab('memo'));

      // --- Auth ---
      async function refreshUser() {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
          userBadge.hidden = false;
          userEmail.textContent = user.email ? user.email.split('@')[0] : (user.user_metadata?.name || 'Logged in');
        } else {
          userBadge.hidden = true;
          userEmail.textContent = '';
        }
        if (authSection) { authSection.hidden = !!user; }
        await loadItems();
      }

      logoutBtn?.addEventListener('click', async () => {
        await supabase.auth.signOut();
        await refreshUser();
      });

      // Email validation helper
      function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      magicBtn?.addEventListener('click', async () => {
        const email = emailInput.value.trim();
        if (!email) return alert('Skriv din e-mail.');

        // Validate email format
        if (!validateEmail(email)) {
          return alert('Indtast en gyldig email adresse.');
        }

        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: window.location.href, shouldCreateUser: false }
        });
        if (error) {
          const msg = (error?.message || '').toLowerCase();
          if (msg.includes('signup') || msg.includes('not allowed') || msg.includes('not found')) {
            return alert('Denne e-mail er ikke inviteret. Kontakt administratoren.');
          }
          return alert('Fejl: ' + error.message);
        }
        alert('Tjek din mail for login-link.');
      });

      githubBtn?.addEventListener('click', async () => {
        const { error } = await supabase.auth.signInWithOAuth({ provider: 'github', options: { redirectTo: window.location.href } });
        if (error) alert('Fejl: ' + error.message);
      });

      // --- Data ---
      async function updateTabCounts() {
        const { count: sc } = await supabase.from('ListItem').select('*', { count: 'exact', head: true }).eq('list_id', 'shopping');
        const { count: mc } = await supabase.from('ListItem').select('*', { count: 'exact', head: true }).eq('list_id', 'memo');
        countShopping.textContent = sc ? `Â· ${sc}` : '';
        countMemo.textContent = mc ? `Â· ${mc}` : '';
      }

      async function loadItems() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          list.innerHTML = '<li class="muted">Log ind for at se listen.</li>';
          countShopping.textContent = '';
          countMemo.textContent = '';
          return;
        }
        const { data, error } = await supabase
          .from('ListItem')
          .select('id, itemName, quantity, user_id, list_id')
          .eq('list_id', activeList)
          .order('id', { ascending: false });
        if (error) {
          list.innerHTML = `<li class="muted">Fejl: ${error.message}</li>`;
          return;
        }
        renderList(data || []);
        updateTabCounts();
      }

      function renderList(items) {
        if (!items.length) {
          list.innerHTML = '<li class="muted" style="padding:10px;text-align:center;">Listen er tom</li>';
          clearAllContainer.hidden = true;
          return;
        }
        clearAllContainer.hidden = false;
        list.innerHTML = '';
        for (const it of items) {
          const li = document.createElement('li');
          li.className = 'item';

          const name = document.createElement('div');
          name.className = 'item-name';
          name.textContent = it.itemName;

          const controls = document.createElement('div');
          controls.className = 'qty-controls';

          const dec = document.createElement('button');
          dec.className = 'qty-btn';
          dec.textContent = 'âˆ’';
          dec.disabled = (it.quantity ?? 1) < 2;
          dec.addEventListener('click', () => updateQuantity(it.id, (it.quantity ?? 1) - 1));

          const qty = document.createElement('span');
          qty.style.cssText = 'min-width:20px;text-align:center;font-weight:600;';
          qty.textContent = String(it.quantity ?? 1);

          const inc = document.createElement('button');
          inc.className = 'qty-btn';
          inc.textContent = '+';
          inc.disabled = (it.quantity ?? 1) > 10;
          inc.addEventListener('click', () => updateQuantity(it.id, (it.quantity ?? 1) + 1));

          const del = document.createElement('button');
          del.className = 'remove-btn';
          del.textContent = 'ðŸ—‘ï¸';
          del.addEventListener('click', () => removeItem(it.id));

          controls.append(dec, qty, inc, del);
          li.append(name, controls);
          list.appendChild(li);
        }
      }

      // Input validation and sanitization helper
      function sanitizeInput(input) {
        // Remove any HTML/script tags and limit length
        return input
          .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
          .replace(/<[^>]+>/g, '')
          .replace(/[<>"'`]/g, '') // Remove potentially dangerous characters
          .trim()
          .substring(0, 100); // Limit to 100 characters
      }

      function validateItemName(name) {
        if (!name || name.length === 0) {
          return { valid: false, error: 'Varenavn mÃ¥ ikke vÃ¦re tomt.' };
        }
        if (name.length > 100) {
          return { valid: false, error: 'Varenavn mÃ¥ max vÃ¦re 100 tegn.' };
        }
        if (!/^[\wÃ¦Ã¸Ã¥Ã†Ã˜Ã…\s\-\.\,\(\)\d]+$/i.test(name)) {
          return { valid: false, error: 'Varenavn indeholder ugyldige tegn.' };
        }
        return { valid: true };
      }

      async function addItem(name) {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return alert('Du skal vÃ¦re logget ind for at tilfÃ¸je varer.');

        // Sanitize and validate input
        const sanitizedName = sanitizeInput(name);
        const validation = validateItemName(sanitizedName);

        if (!validation.valid) {
          return alert(validation.error);
        }

        const { error } = await supabase
          .from('ListItem')
          .insert({ itemName: sanitizedName, quantity: 1, user_id: user.id, list_id: activeList });
        if (error) return alert('Fejl: ' + error.message);
        itemInput.value = '';
        await loadItems();
      }

      async function updateQuantity(id, q) {
        // Validate quantity
        if (!Number.isInteger(q) || q < 1 || q > 99) {
          return alert('Antal skal vÃ¦re mellem 1 og 99.');
        }

        const { error } = await supabase
          .from('ListItem')
          .update({ quantity: q })
          .eq('id', id);
        if (error) return alert('Fejl: ' + error.message);
        await loadItems();
      }

      async function removeItem(id) {
        if (!confirm('Slet denne vare?')) return;
        const { error } = await supabase
          .from('ListItem')
          .delete()
          .eq('id', id);
        if (error) return alert('Fejl: ' + error.message);
        await loadItems();
      }

      async function clearAllItems() {
        const listLabel = activeList === 'shopping' ? 'indkÃ¸bslisten' : 'huskelisten';
        if (!confirm(`Er du sikker pÃ¥, at du vil slette alle varer fra ${listLabel}?`)) return;
        const { error } = await supabase
          .from('ListItem')
          .delete()
          .eq('list_id', activeList)
          .neq('id', 0);
        if (error) return alert('Fejl: ' + error.message);
        await loadItems();
      }

      addBtn.addEventListener('click', async () => {
        const name = itemInput.value.trim();
        if (!name) return;
        await addItem(name);
      });

      itemInput.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
          const name = itemInput.value.trim();
          if (!name) return;
          await addItem(name);
        }
      });

      clearAllBtn?.addEventListener('click', clearAllItems);

      // HÃ¥ndtÃ©r deep-link fra Magic Link / OAuth
      window.addEventListener('hashchange', refreshUser);

      // Lyt efter session-Ã¦ndringer (persist + auto-refresh)
      supabase.auth.onAuthStateChange((event, session) => {
        refreshUser();
        logConnection(event, session?.user || null);
      });
      window.addEventListener('load', async () => {
        await refreshUser();
        const { data: { user } } = await supabase.auth.getUser();
        logConnection('page_load', user);
      });

      // Realtime: lyt pÃ¥ Ã¦ndringer i ListItem (alle brugere)
      supabase.channel('realtime:ListItem')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'ListItem' }, (payload) => {
          const row = payload.new || payload.old;
          if (!row || !row.list_id || row.list_id === activeList) loadItems();
        })
        .subscribe();

      // PWA: registrÃ©r service worker (GitHub Pages subpath-safe)
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').catch(() => {});
        });
      }
    </script>
  </body>
</html>
