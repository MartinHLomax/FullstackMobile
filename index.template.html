<!doctype html>
<html lang="da">
  <head>
    <meta charset="utf-8" />
    <!-- Content Security Policy for enhanced security -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' 'unsafe-inline' https://esm.sh https://cdn.jsdelivr.net;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: https:;
      connect-src 'self' https://*.supabase.co wss://*.supabase.co;
      font-src 'self' data:;
      object-src 'none';
      base-uri 'self';
      form-action 'self';
      frame-ancestors 'none';
      upgrade-insecure-requests;
    ">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0b1020" />
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <title>Shopping List ¬∑ Supabase + GitHub Pages</title>
    <style>
      :root { --gap: 12px; --radius: 14px; }
      html, body { margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; background:#0b1020; color:#f2f4f8; }
      a { color: inherit; }
      .wrap { max-width: 900px; margin: 0 auto; padding: 24px 16px 80px; }
      header { display:flex; align-items:center; justify-content:space-between; gap:var(--gap); margin-bottom: 16px; }
      .card { background: #121935; border: 1px solid #273057; border-radius: var(--radius); padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,0.25); }
      .row { display:flex; gap: var(--gap); align-items:center; }
      .muted { color:#a6b0d6; font-size: 14px; }
      button, input { font: inherit; }
      button { padding: 10px 14px; border-radius: 12px; border:1px solid #3d4b86; background:#1a244d; color:#fff; cursor:pointer; }
      button:hover { filter: brightness(1.1); }
      input[type="text"], input[type="email"] { padding: 10px 12px; border-radius: 12px; border:1px solid #3d4b86; background:#0f1633; color:#fff; width:100%; }
      .pill { padding: 4px 8px; border:1px solid #3d4b86; background:#0f1633; border-radius: 999px; font-size:12px; }
      ul { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px; }
      li.item { display:flex; align-items:center; justify-content:space-between; gap:var(--gap); background:#0f1633; border:1px solid #273057; border-radius: 12px; padding: 10px; }
      .item-name { font-weight:600; }
      .qty-controls { display:flex; align-items:center; gap:8px; }
      .qty-btn { width:36px; height:36px; border-radius:12px; }
      .remove-btn { background:#5c1a2a; border-color:#a43d5b; }
      .stats { display:flex; gap:10px; align-items:center; }
      .tab-bar { display:flex; gap:0; }
      .tab-btn { flex:1; padding:10px 0; border:1px solid #273057; background:#0f1633; color:#a6b0d6; font-weight:600; font-size:14px; cursor:pointer; transition:background 0.15s, color 0.15s; border-bottom:2px solid transparent; }
      .tab-btn:first-child { border-radius:14px 0 0 0; }
      .tab-btn:last-child { border-radius:0 14px 0 0; }
      .tab-btn:hover { background:#1a244d; }
      .tab-btn.active { background:#121935; color:#f2f4f8; border-bottom-color:#3ecf8e; }
      .list-card-tabs { border-top-left-radius:0; border-top-right-radius:0; border-top:none; margin-top:0; }
      .grid { display:grid; grid-template-columns: 1fr; gap: var(--gap); }
      @media (min-width: 760px) { .grid { grid-template-columns: 1.2fr 1fr; } }
      footer { margin-top: 36px; text-align:center; color:#8ea0d0; font-size:13px; }
      /* Compact add-item card */
      .add-card h2 { margin: 4px 0 8px !important; }
      .add-card .row { gap: 8px; }
      .add-card input[type="text"] { padding: 6px 10px; height: 36px; }
      .add-card button { height: 36px; padding: 0 12px; }
  /* Compact add-item card */
      .add-card h2 { margin: 4px 0 8px !important; }
      .add-card .row { gap: 8px; }
      .add-card input[type="text"] { padding: 6px 10px; height: 36px; }
      .add-card button { height: 36px; padding: 0 12px; }

      /* Mobile responsiveness */
      @media (max-width: 520px) {
        .wrap { padding: 16px 12px 64px; }
        header { flex-direction: column; align-items: flex-start; gap: 8px; }
        h1 { font-size: 20px !important; }
        .stats { gap: 6px; flex-wrap: wrap; }
        .row { gap: 10px; }
        .grid { grid-template-columns: 1fr; }
        .card { padding: 12px; }
        .pill { font-size: 11px; }
        /* List items stack nicely */
        li.item { display: grid; grid-template-columns: 1fr; row-gap: 8px; align-items: start; }
        li.item .row { justify-content: space-between; width: 100%; }
        .item-name { word-break: break-word; }
        .qty-controls { justify-content: space-between; width: 100%; }
        .qty-btn, .remove-btn { width: 40px; height: 40px; padding: 0; }
        /* Add-item stays one line with right-aligned + button */
        .add-card input[type="text"] { height: 40px; }
        .add-card button { height: 40px; padding: 0 12px; }
        #addBtn { flex: 0 0 48px; min-width: 48px; }
        .tab-btn { font-size:13px; padding:8px 0; }
      }
</style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div>
          <h1 style="margin:0;font-size:24px;">üõí Shopping List</h1>
        </div>
        <div class="row">
          <div class="stats" id="stats">
            <span class="pill" id="itemCount">0 items</span>
            <span class="pill" id="totalQty">0 total</span>
          </div>
          <div class="row" id="userBadge" hidden>
            <span class="pill" id="userEmail"></span>
            <button id="logoutBtn" title="Log ud">Log ud</button>
          </div>
        </div>
      </header>

      <div class="grid">
        <!-- Auth -->
        <section class="card" id="authSection">
          <h2 style="margin-top:0;">Login</h2>
          <p class="muted">Kun inviterede brugere kan logge ind.</p>
          <div class="row">
            <input id="emailInput" type="email" placeholder="din@email.dk" />
            <button id="magicBtn">Send login-link</button>
          </div>          
        </section>

        <!-- Add item -->
        <section class="card add-card compact"><h2 style="margin-top:0;">Tilf√∏j vare</h2>
          <div class="row">
            <input id="itemInput" type="text" placeholder="Tilf√∏j ny vare..." />
            <button id="addBtn" title="Tilf√∏j">+
            </button>
          </div>
          <p class="muted">Standard antal = 1. Just√©r med +/- i listen.</p>
        </section>
      </div>

      <div style="margin-top: 12px;">
        <div class="tab-bar">
          <button class="tab-btn active" data-list="shopping" id="tabShopping">üõí Indk√∏bsliste</button>
          <button class="tab-btn" data-list="memo" id="tabMemo">üìù Huskeliste</button>
        </div>
        <section class="card list-card-tabs">
          <ul id="list"></ul>
          <div id="clearAllContainer" style="margin-top: 16px; text-align: center;" hidden>
            <button id="clearAllBtn" style="background:#5c1a2a; border-color:#a43d5b;">üóëÔ∏è Slet alle varer</button>
          </div>
        </section>
      </div>

      <footer>
        Bygget med <a href="https://supabase.com" target="_blank" rel="noreferrer">Supabase</a>. Hostet p√• GitHub Pages.
      </footer>
    </div>

    <script type="module">
      const SUPABASE_URL = "{{SUPABASE_URL}}"; // Will be replaced by build script
      const SUPABASE_ANON_KEY = "{{SUPABASE_ANON_KEY}}"; // Will be replaced by build script

      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true,
          storage: window.localStorage
        }
      });

      // --- Connection Logging ---
      let _lastLogTime = 0;
      const LOG_THROTTLE_MS = 5000;

      async function logConnection(eventType, user) {
        const now = Date.now();
        if (now - _lastLogTime < LOG_THROTTLE_MS) return;
        _lastLogTime = now;

        if (eventType === 'TOKEN_REFRESHED' || eventType === 'INITIAL_SESSION') return;

        if (!user) {
          const { data: { user: currentUser } } = await supabase.auth.getUser();
          user = currentUser;
        }
        if (!user) return;

        const isPwa = window.matchMedia('(display-mode: standalone)').matches
          || window.navigator.standalone === true
          || window.location.search.includes('source=pwa');

        const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;

        const entry = {
          user_id:         user.id,
          email:           user.email || null,
          event_type:      eventType,
          user_agent:      navigator.userAgent || null,
          language:        navigator.language || null,
          platform:        navigator.platform || null,
          screen_w:        screen.width || null,
          screen_h:        screen.height || null,
          viewport_w:      window.innerWidth || null,
          viewport_h:      window.innerHeight || null,
          referrer:        document.referrer || null,
          page_url:        window.location.href || null,
          is_pwa:          isPwa,
          connection_type: conn?.effectiveType || null,
          is_online:       navigator.onLine
        };

        supabase.from('connection_log').insert(entry).then(({ error }) => {
          if (error) console.warn('Connection log error:', error.message);
        });
      }

      // UI refs
      const userBadge = document.getElementById('userBadge');
      const userEmail = document.getElementById('userEmail');
      const logoutBtn = document.getElementById('logoutBtn');
      const magicBtn = document.getElementById('magicBtn');
      const emailInput = document.getElementById('emailInput');
      const githubBtn = document.getElementById('githubBtn');
      const authSection = document.getElementById('authSection');
      const itemInput = document.getElementById('itemInput');
      const addBtn = document.getElementById('addBtn');
      const list = document.getElementById('list');
      const itemCount = document.getElementById('itemCount');
      const totalQty = document.getElementById('totalQty');
      const clearAllContainer = document.getElementById('clearAllContainer');
      const clearAllBtn = document.getElementById('clearAllBtn');

      // --- Tab state ---
      let activeList = 'shopping';
      const tabShopping = document.getElementById('tabShopping');
      const tabMemo = document.getElementById('tabMemo');

      function switchTab(listId) {
        activeList = listId;
        tabShopping.classList.toggle('active', listId === 'shopping');
        tabMemo.classList.toggle('active', listId === 'memo');
        loadItems();
      }
      tabShopping?.addEventListener('click', () => switchTab('shopping'));
      tabMemo?.addEventListener('click', () => switchTab('memo'));

      // --- Auth ---
      async function refreshUser() {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
          userBadge.hidden = false;
          userEmail.textContent = user.email ? user.email.split('@')[0] : (user.user_metadata?.name || 'Logged in');
        } else {
          userBadge.hidden = true;
          userEmail.textContent = '';
        }
        if (authSection) { authSection.hidden = !!user; }
        await loadItems();
      }

      logoutBtn?.addEventListener('click', async () => {
        await supabase.auth.signOut();
        await refreshUser();
      });

      // Email validation helper
      function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      magicBtn?.addEventListener('click', async () => {
        const email = emailInput.value.trim();
        if (!email) return alert('Skriv din e-mail.');

        // Validate email format
        if (!validateEmail(email)) {
          return alert('Indtast en gyldig email adresse.');
        }

        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: window.location.href, shouldCreateUser: false }
        });
        if (error) {
          const msg = (error?.message || '').toLowerCase();
          if (msg.includes('signup') || msg.includes('not allowed') || msg.includes('not found')) {
            return alert('Denne e-mail er ikke inviteret. Kontakt administratoren.');
          }
          return alert('Fejl: ' + error.message);
        }
        alert('Tjek din mail for login-link.');
      });

      githubBtn?.addEventListener('click', async () => {
        const { error } = await supabase.auth.signInWithOAuth({ provider: 'github', options: { redirectTo: window.location.href } });
        if (error) alert('Fejl: ' + error.message);
      });

      // --- Data ---
      async function loadItems() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          list.innerHTML = '<li class="muted">Log ind for at se listen.</li>';
          itemCount.textContent = '0 items';
          totalQty.textContent = '0 total';
          return;
        }
        const { data, error } = await supabase
          .from('ListItem') // bem√¶rk: mixed-case tabelnavn
          .select('id, itemName, quantity, user_id, list_id')
          .eq('list_id', activeList)
          .order('id', { ascending: false });
        if (error) {
          list.innerHTML = `<li class="muted">Fejl: ${error.message}</li>`;
          itemCount.textContent = '0 items';
          totalQty.textContent = '0 total';
          return;
        }
        renderList(data || []);
      }

      function renderList(items) {
        if (!items.length) {
          list.innerHTML = `
            <li class="muted" style="padding:10px;">
              Listen er tom ‚Äî tilf√∏j en vare.
            </li>`;
          itemCount.textContent = '0 items';
          totalQty.textContent = '0 total';
          clearAllContainer.hidden = true;
          return;
        }
        clearAllContainer.hidden = false;
        list.innerHTML = '';
        let total = 0;
        for (const it of items) {
          total += (it.quantity || 0);
          const li = document.createElement('li');
          li.className = 'item';

          const left = document.createElement('div');
          left.className = 'row';
          const name = document.createElement('div');
          name.className = 'item-name';
          name.textContent = it.itemName;
          left.appendChild(name);

          const controls = document.createElement('div');
          controls.className = 'qty-controls';

          const dec = document.createElement('button');
          dec.className = 'qty-btn';
          dec.textContent = '‚àí';
          dec.title = 'Mindsk antal';
          dec.disabled = (it.quantity ?? 1) < 2;
          dec.addEventListener('click', () => updateQuantity(it.id, (it.quantity ?? 1) - 1));

          const qty = document.createElement('span');
          qty.textContent = String(it.quantity ?? 1);

          const inc = document.createElement('button');
          inc.className = 'qty-btn';
          inc.textContent = '+';
          inc.title = '√òg antal';
          inc.disabled = (it.quantity ?? 1) > 10; // samme logik som dit POC
          inc.addEventListener('click', () => updateQuantity(it.id, (it.quantity ?? 1) + 1));

          const del = document.createElement('button');
          del.className = 'remove-btn';
          del.textContent = 'üóëÔ∏è';
          del.title = 'Slet';
          del.addEventListener('click', () => removeItem(it.id));

          controls.append(dec, qty, inc, del);
          li.append(left, controls);
          list.appendChild(li);
        }
        itemCount.textContent = `${items.length} items`;
        totalQty.textContent = `${total} total`;
      }

      // Input validation and sanitization helper
      function sanitizeInput(input) {
        // Remove any HTML/script tags and limit length
        return input
          .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
          .replace(/<[^>]+>/g, '')
          .replace(/[<>"'`]/g, '') // Remove potentially dangerous characters
          .trim()
          .substring(0, 100); // Limit to 100 characters
      }

      function validateItemName(name) {
        if (!name || name.length === 0) {
          return { valid: false, error: 'Varenavn m√• ikke v√¶re tomt.' };
        }
        if (name.length > 100) {
          return { valid: false, error: 'Varenavn m√• max v√¶re 100 tegn.' };
        }
        if (!/^[\w√¶√∏√•√Ü√ò√Ö\s\-\.\,\(\)\d]+$/i.test(name)) {
          return { valid: false, error: 'Varenavn indeholder ugyldige tegn.' };
        }
        return { valid: true };
      }

      async function addItem(name) {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return alert('Du skal v√¶re logget ind for at tilf√∏je varer.');

        // Sanitize and validate input
        const sanitizedName = sanitizeInput(name);
        const validation = validateItemName(sanitizedName);

        if (!validation.valid) {
          return alert(validation.error);
        }

        const { error } = await supabase
          .from('ListItem')
          .insert({ itemName: sanitizedName, quantity: 1, user_id: user.id, list_id: activeList });
        if (error) return alert('Fejl: ' + error.message);
        itemInput.value = '';
        await loadItems();
      }

      async function updateQuantity(id, q) {
        // Validate quantity
        if (!Number.isInteger(q) || q < 1 || q > 99) {
          return alert('Antal skal v√¶re mellem 1 og 99.');
        }

        const { error } = await supabase
          .from('ListItem')
          .update({ quantity: q })
          .eq('id', id);
        if (error) return alert('Fejl: ' + error.message);
        await loadItems();
      }

      async function removeItem(id) {
        if (!confirm('Slet denne vare?')) return;
        const { error } = await supabase
          .from('ListItem')
          .delete()
          .eq('id', id);
        if (error) return alert('Fejl: ' + error.message);
        await loadItems();
      }

      async function clearAllItems() {
        const listLabel = activeList === 'shopping' ? 'indk√∏bslisten' : 'huskelisten';
        if (!confirm(`Er du sikker p√•, at du vil slette alle varer fra ${listLabel}?`)) return;
        const { error } = await supabase
          .from('ListItem')
          .delete()
          .eq('list_id', activeList)
          .neq('id', 0);
        if (error) return alert('Fejl: ' + error.message);
        await loadItems();
      }

      addBtn.addEventListener('click', async () => {
        const name = itemInput.value.trim();
        if (!name) return;
        await addItem(name);
      });

      itemInput.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
          const name = itemInput.value.trim();
          if (!name) return;
          await addItem(name);
        }
      });

      clearAllBtn?.addEventListener('click', clearAllItems);

      // H√•ndt√©r deep-link fra Magic Link / OAuth
      window.addEventListener('hashchange', refreshUser);

      // Lyt efter session-√¶ndringer (persist + auto-refresh)
      supabase.auth.onAuthStateChange((event, session) => {
        refreshUser();
        logConnection(event, session?.user || null);
      });
      window.addEventListener('load', async () => {
        await refreshUser();
        const { data: { user } } = await supabase.auth.getUser();
        logConnection('page_load', user);
      });

      // Realtime: lyt p√• √¶ndringer i ListItem (alle brugere)
      supabase.channel('realtime:ListItem')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'ListItem' }, (payload) => {
          const row = payload.new || payload.old;
          if (!row || !row.list_id || row.list_id === activeList) loadItems();
        })
        .subscribe();

      // PWA: registr√©r service worker (GitHub Pages subpath-safe)
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').catch(() => {});
        });
      }
    </script>
  </body>
</html>
